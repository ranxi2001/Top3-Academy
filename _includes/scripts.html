<script>
    (function () {
        // 主题切换
        const themeToggle = document.getElementById('themeToggle');
        const prismLight = document.getElementById('prism-light');
        const prismDark = document.getElementById('prism-dark');

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                if (prismLight) prismLight.disabled = true;
                if (prismDark) prismDark.disabled = false;
            } else {
                if (prismLight) prismLight.disabled = false;
                if (prismDark) prismDark.disabled = true;
            }
        }

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
        }

        // 移动端菜单
        const menuToggle = document.getElementById('menuToggle');
        const mainNav = document.getElementById('mainNav');

        if (menuToggle && mainNav) {
            menuToggle.addEventListener('click', function () {
                this.classList.toggle('active');
                mainNav.classList.toggle('open');
                document.body.style.overflow = mainNav.classList.contains('open') ? 'hidden' : '';
            });

            mainNav.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    menuToggle.classList.remove('active');
                    mainNav.classList.remove('open');
                    document.body.style.overflow = '';
                });
            });
        }
    })();
</script>

<!-- Mermaid JS -->
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    // Unified Mermaid Loader
    (function () {
        async function initMermaid() {
            // Avoid running twice
            if (window._mermaidInitialized) return;
            window._mermaidInitialized = true;

            // 1. Find all potential Mermaid blocks
            // Strategy: Look for 'language-mermaid' class OR content starting with keywords
            const codeBlocks = document.querySelectorAll('pre code');

            const keywords = ['sequenceDiagram', 'mindmap', 'graph', 'flowchart', 'classDiagram', 'gantt', 'pie'];
            const mermaidNodes = [];

            codeBlocks.forEach(block => {
                let isMermaid = false;
                const text = block.textContent.trim();

                // Check class
                if (block.classList.contains('language-mermaid') || block.closest('.language-mermaid')) {
                    isMermaid = true;
                }
                // Check content keywords
                else {
                    for (const kw of keywords) {
                        if (text.startsWith(kw)) {
                            isMermaid = true;
                            break;
                        }
                    }
                }

                if (isMermaid) {
                    const div = document.createElement('div');
                    div.className = 'mermaid';
                    div.style.textAlign = 'center';
                    div.style.background = 'var(--bg-tertiary)';
                    div.style.padding = '20px';
                    div.style.borderRadius = '12px';
                    div.textContent = text;
                    mermaidNodes.push({ block, div });
                }
            });

            // 2. Perform replacements
            mermaidNodes.forEach(({ block, div }) => {
                const pre = block.closest('pre');
                const wrapper = pre.closest('div.highlighter-rouge, div.highlight');
                if (wrapper) {
                    wrapper.replaceWith(div);
                } else if (pre) {
                    pre.replaceWith(div);
                } else {
                    block.replaceWith(div);
                }
            });

            // 3. Initialize and Run Mermaid
            // We use var() for colors that change between themes to ensure dynamic switching works
            const style = getComputedStyle(document.body);
            const primary = style.getPropertyValue('--primary').trim();

            mermaid.initialize({
                startOnLoad: false,
                theme: 'base',
                themeVariables: {
                    fontFamily: 'Inter, sans-serif',
                    primaryColor: primary,
                    primaryTextColor: '#fff',
                    primaryBorderColor: primary,
                    lineColor: 'var(--text-primary)',
                    secondaryColor: 'var(--bg-secondary)',
                    tertiaryColor: 'var(--bg-tertiary)',
                    textColor: 'var(--text-primary)',
                    signalTextColor: 'var(--text-primary)',
                    actorTextColor: '#fff',
                    noteTextColor: 'var(--text-primary)',
                    loopTextColor: 'var(--text-primary)',
                    activationBorderColor: primary
                }
            });

            const allMermaidDivs = document.querySelectorAll('.mermaid');
            if (allMermaidDivs.length > 0) {
                await mermaid.run({
                    querySelector: '.mermaid'
                });
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMermaid);
        } else {
            initMermaid();
        }
    })();
</script>