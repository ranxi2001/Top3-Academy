<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <!-- 字符集和浏览器兼容性 -->
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">

<!-- SEO Meta Tags -->
<meta name="description" content="Web3顶级学习平台 | 智能合约开发、链上交互和前端DApp开发实战教程，从入门到精通！">
<meta name="keywords" content="Web3, 区块链, 智能合约, Solidity, DApp, 去中心化应用, 教程">
<meta name="author" content="Top3 Academy">

<!-- Open Graph -->
<meta property="og:title" content="深入理解链上交互：签名、广播与授权机制 | Top3 Academy">
<meta property="og:description" content="Web3顶级学习平台 | 智能合约开发、链上交互和前端DApp开发实战教程，从入门到精通！">
<meta property="og:type" content="website">
<meta property="og:url" content="https://learnweb3.top/chain_interaction/signing_authorization.html">

<!-- 页面标题 -->
<title>深入理解链上交互：签名、广播与授权机制 | Top3 Academy</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="/assets/img/logo.png">
<link rel="apple-touch-icon" href="/assets/img/logo.png">

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- 站点样式表 -->
<link rel="stylesheet" href="/assets/css/main.css">

<!-- 语法高亮 - Prism.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" id="prism-light">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
    id="prism-dark" disabled>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

<!-- 主题初始化脚本 (避免闪烁) -->
<script>
    (function () {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
    })();
</script>
</head>

<body>
    <header>
    <div class="container">
        <div id="branding">
            <a href="/" class="logo-link">
                <img src="/assets/img/logo.png" alt="Top3 Academy Logo" class="logo">
                <span class="site-title">Top3 Academy</span>
            </a>
        </div>

        <nav id="mainNav">
            <ul>
                <li><a href="/smart_contract/">智能合约</a></li>
                <li><a href="/chain_interaction/">链上交互</a></li>
                <li><a href="/Front-end_Interaction/">前端交互</a></li>
                <li><a href="/friends/">友情链接</a></li>
            </ul>
        </nav>

        <div class="header-actions">
            <!-- 主题切换按钮 -->
            <button class="theme-toggle" id="themeToggle" aria-label="切换主题">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" />
                </svg>
                <svg class="moon-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z" />
                </svg>
            </button>

            <!-- 汉堡菜单按钮 (移动端) -->
            <button class="hamburger" id="menuToggle" aria-label="菜单">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>
</header>

    <!-- 侧边栏遮罩层 -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- 课程文档布局 -->
    <div class="course-document">
        <aside class="sidebar" id="sidebar">
            <h2>目录</h2>
            <nav class="lesson-nav">
                <ul>
                    
                    
                    
                    
                    
                    
                    
                    
                    <li class="active" >
                        <a href="/chain_interaction/signing_authorization.html">深入理解链上交互：签名、广播与授权机制</a>
                    </li>
                    
                    
                </ul>
            </nav>
        </aside>

        <main class="content">
            <h1 id="你的资产真的安全吗从-espressosys-创始人被盗谈起">你的资产真的安全吗？从 EspressoSys 创始人被盗谈起</h1>

<p>EspressoSys 联合创始人的钱包被盗，损失惨重。原因既令人惋惜又发人深省：几个月前，她在测试某个合约时，即使交互金额仅有 <strong>5 USDC</strong>，却给予了该合约 <strong>无限授权 (Infinite Approval)</strong>。</p>

<p>当该测试合约后来被发现存在漏洞时，攻击者利用这些“历史遗留的无限授权”，直接从已授权用户的钱包中转走了资产。你早已忘记的一次测试授权，可能在未来某一天，成为黑客搬空你钱包的后门。</p>

<p>这引出了一个核心问题：<strong>我们在点击钱包上的“确认”时，到底发生了什么？</strong></p>

<h2 id="1-授权-approve-到底是什么">1. 授权 (Approve) 到底是什么？</h2>

<p>在以太坊和 EVM 兼容链上，处理 ERC-20 代币（如 USDC, USDT, UNI）时，有一个独特的机制叫 <strong>Approve（授权）</strong>。</p>

<h3 id="为什么需要授权">为什么需要授权？</h3>
<p>ETH 是原生资产，转账时直接携带价值，就像原本就在信封里的现金。但在智能合约的世界里，ERC-20 代币只是合约账本上的一个数字。当你想要在一个去中心化交易所 (DEX) 交易，或者在借贷协议中存款时，你不能直接把币“推”给合约，而是需要先告诉代币合约：“我允许这个 DEX 合约从我的账户里拿走多少钱”。</p>

<h3 id="授权-vs-转账">授权 vs 转账</h3>
<ul>
  <li><strong>转账 (Transfer)</strong>: 你主动发起，把代币发送给别人。需私钥签名。</li>
  <li><strong>授权 (Approve) + 调用 (TransferFrom)</strong>: 你先签署一个授权交易，允许通过验证的第三方合约（Spender）在未来随时从你的账户里“拉取”代币。</li>
</ul>

<pre><code class="language-mermaid">sequenceDiagram
    participant User as 用户 (User)
    participant Token as 代币合约 (USDC/USDT)
    participant DeFi as DeFi 协议 (Uniswap/Aave)

    Note right of User: 步骤 1: 授权 (Approve)
    User-&gt;&gt;Token: 发送 Approve 交易 (允许 DeFi 动用 1000 USDC)
    Token--&gt;&gt;Token: 更新 Allowances 账本: DeFi 可动用 User 1000 USDC

    Note right of User: 步骤 2: 交互 (Swap/Deposit)
    User-&gt;&gt;DeFi: 调用 Swap/Deposit 函数
    DeFi-&gt;&gt;Token: 调用 transferFrom(User, DeFi, 1000)
    Token--&gt;&gt;Token: 检查 Allowance &gt;= 1000? 是 -&gt; 转账
    Token--&gt;&gt;DeFi: 转账成功
</code></pre>

<h3 id="风险点无限授权">风险点：无限授权</h3>
<p>为了用户体验，很多早期的 DeFi 协议（甚至现在的习惯）会引导用户进行 <strong>无限授权 (Infinite Approval)</strong>。
这意味着你告诉代币合约：“我允许这个协议转走我 <strong>无限多</strong> 的代币”。</p>
<ul>
  <li><strong>好处</strong>：省 Gas，以后再交互不用重复授权。</li>
  <li><strong>坏处</strong>：如果该协议合约存在漏洞被黑客控制，或者项目方作恶，他们可以随时利用这个“无限额度”转走你钱包里该代币的所有余额，而不需要你再次签名。</li>
</ul>

<h2 id="2-离线签名与-gasless-授权-permit--permit2">2. 离线签名与 Gasless 授权 (Permit / Permit2)</h2>

<p>你可能注意到了，现在的很多新协议不需要你发一笔昂贵的 Approve 交易，而是弹出一个签名框让你签名一段看不懂的文字，这就涉及到 <strong>离线签名 (Off-chain Signing)</strong> 技术。</p>

<h3 id="什么是离线签名">什么是离线签名？</h3>
<p>传统的 Approve 是链上交易，需要消耗 Gas。而离线签名（基于 EIP-2612 或 EIP-712）是你用私钥对一段特定的数据（消息）进行签名，这个签名不上链，不花钱。
你把这个签名给协议，协议拿着这个签名去链上帮你在操作的同时完成授权。</p>

<h3 id="permit-eip-2612">Permit (EIP-2612)</h3>
<p>这是代币合约原生支持的功能。</p>
<ol>
  <li>用户在钱包签名一个消息：“我授权 Spender 动用我 X 金额，截止时间 T，签名是 S”。</li>
  <li>用户把签名 S 给 Relayer（或者协议前端）。</li>
  <li>协议在执行 Swap 时，先调用代币的 <code class="language-plaintext highlighter-rouge">permit()</code> 函数提交签名。</li>
  <li>代币合约验证签名有效，自动修改 Allowance。</li>
  <li>协议随后立即调用 <code class="language-plaintext highlighter-rouge">transferFrom</code> 完成交易。</li>
</ol>

<h3 id="permit2-uniswap-推出">Permit2 (Uniswap 推出)</h3>
<p>为了解决老代币不支持 Permit 的问题，Uniswap 推出了 Permit2。</p>
<ul>
  <li><strong>原理</strong>：用户先给 Permit2 合约一个无限授权（只做一次）。以后所有的交互，都通过离线签名告诉 Permit2：“我允许 Uniswap 这次操作用多少钱”。</li>
  <li><strong>优势</strong>：
    <ul>
      <li><strong>安全性</strong>：虽然你授权给了 Permit2 无限额度，但 Permit2 本身是经过严格审计的基础设施。具体的 DApp 每次只能拿到你“单次签名”的临时额度。</li>
      <li><strong>自动过期</strong>：可以设置签名的有效期，过期作废。</li>
    </ul>
  </li>
</ul>

<pre><code class="language-mermaid">sequenceDiagram
    participant User as 用户
    participant App as DApp前端
    participant Permit2 as Permit2 合约
    participant Token as 代币合约

    Note over User, Token: 前置条件: User 已 Approve 无限额度给 Permit2

    User-&gt;&gt;App: 想要 Swap 100 USDC
    App--&gt;&gt;User: 请求签名 (Permit2 格式: 允许 DApp 转 100 USDC, 10分钟有效)
    User-&gt;&gt;User: 钱包离线签名 (不花 Gas)
    User-&gt;&gt;App: 返回签名
    App-&gt;&gt;Permit2: 提交交易: permitTransferFrom(签名, User, 100 USDC)
    Permit2-&gt;&gt;Token: transferFrom(User, App, 100 USDC)
    Token--&gt;&gt;Permit2: 成功
    Permit2--&gt;&gt;App: 资产到账
</code></pre>

<h2 id="3-广播机制与交易上链">3. 广播机制与交易上链</h2>

<p>当我们在这个过程中提到“广播”时，指的是：</p>
<ol>
  <li><strong>构造交易</strong>：钱包根据你的操作（比如转账、Approve、或者附带签名的 Swap）构造好一串二进制数据。</li>
  <li><strong>签名</strong>：你用私钥对这串数据签名，证明是你发起的。</li>
  <li><strong>广播 (Broadcast)</strong>：钱包节点把这串带签名的数据发送到区块链的 P2P 网络（Mempool）。</li>
  <li><strong>打包</strong>：矿工/验证者从 Mempool 捡起你的交易，验证签名无误，余额足够，然后打包进区块。</li>
</ol>

<p><strong>注意</strong>：离线签名本身不广播，它是把“签名数据”作为参数，包含在另一笔由协议（或 Relayer）发起并广播的交易中。</p>

<h2 id="4-安全最佳实践如何保护你的钱包">4. 安全最佳实践：如何保护你的钱包？</h2>

<p>回到开头的故事，我们能学到什么？</p>

<ol>
  <li><strong>拒绝盲目无限授权</strong>：
    <ul>
      <li>在 Metamask / Rabby 等钱包中，当弹出授权窗口时，<strong>手动修改额度</strong>。如果只需要交互 100 U，就只填 100，不要默认给无限。</li>
      <li>尤其对于新项目、土狗项目、测试项目，<strong>绝对不要</strong>给无限授权。</li>
    </ul>
  </li>
  <li><strong>定期体检与撤销 (Revoke)</strong>：
    <ul>
      <li>即使是正规项目，授权完如果长期不用，也建议撤销。</li>
      <li><strong>工具推荐</strong>：
        <ul>
          <li><a href="https://revoke.cash/">Revoke.cash</a></li>
          <li><a href="https://debank.com/">DeBank</a></li>
          <li><a href="https://rabby.io/">Rabby Wallet</a> (内置安全扫描)</li>
        </ul>
      </li>
      <li>养成习惯：每隔几个月，或在重大黑客事件发生后，检查你的授权列表。</li>
    </ul>
  </li>
  <li><strong>账户隔离</strong>：
    <ul>
      <li><strong>主资金钱包 (Vault)</strong>：只存钱，极少交互，只授权给最最顶级的协议（如 Uniswap, Aave 主网），且用完即撤。</li>
      <li><strong>Degen 钱包</strong>：存少量资金，专门用来冲土狗、测试新协议。被盗也不心疼。</li>
      <li><strong>硬件钱包</strong>：对于大额资产，务必使用硬件钱包，并配合多重签名 (Multisig) 更佳。</li>
    </ul>
  </li>
  <li><strong>看清签名的内容</strong>：
    <ul>
      <li>随着 Permit 的普及，钓鱼攻击也升级了。黑客会伪造一个“登录签名”或者“领空投签名”，实际是一笔 Permit 授权签名。</li>
      <li><strong>务必检查</strong>：签名的对象是谁？额度是多少？</li>
      <li>如果钱包提示正在签署“Permit”或“SetApprovalForAll”，务必打起十二分精神。</li>
    </ul>
  </li>
</ol>

<hr />

<p><strong>总结</strong>：区块链赋予了你对自己资产的完全掌控权，但同时也赋予了你保卫资产的完全责任。理解 <code class="language-plaintext highlighter-rouge">Approve</code>、<code class="language-plaintext highlighter-rouge">Signature</code> 和 <code class="language-plaintext highlighter-rouge">Broadcast</code> 的底层逻辑，是成为合格 Web3 玩家的第一课。</p>


            <div class="lesson-footer">
                <p>最后更新于 2025年12月26日</p>
                
            </div>

            <div class="pagination">
                
                
            </div>
        </main>
    </div>

    <!-- 侧边栏切换按钮 -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="切换目录">
        <svg viewBox="0 0 24 24" fill="white">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
        </svg>
    </button>

    <footer>
    <div class="container">
        <p>&copy; 2025 Top3 Academy. All rights reserved. | <a
                href="https://learnweb3.top">learnweb3.top</a> | Made by <a href="https://x.com/Onefly"
                target="_blank">Onefly</a></p>
    </div>
</footer>
    <script>
    (function () {
        // 主题切换
        const themeToggle = document.getElementById('themeToggle');
        const prismLight = document.getElementById('prism-light');
        const prismDark = document.getElementById('prism-dark');

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (theme === 'dark') {
                if (prismLight) prismLight.disabled = true;
                if (prismDark) prismDark.disabled = false;
            } else {
                if (prismLight) prismLight.disabled = false;
                if (prismDark) prismDark.disabled = true;
            }
        }

        const savedTheme = localStorage.getItem('theme') || 'light';
        setTheme(savedTheme);

        if (themeToggle) {
            themeToggle.addEventListener('click', function () {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                setTheme(currentTheme === 'dark' ? 'light' : 'dark');
            });
        }

        // 移动端菜单
        const menuToggle = document.getElementById('menuToggle');
        const mainNav = document.getElementById('mainNav');

        if (menuToggle && mainNav) {
            menuToggle.addEventListener('click', function () {
                this.classList.toggle('active');
                mainNav.classList.toggle('open');
                document.body.style.overflow = mainNav.classList.contains('open') ? 'hidden' : '';
            });

            mainNav.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    menuToggle.classList.remove('active');
                    mainNav.classList.remove('open');
                    document.body.style.overflow = '';
                });
            });
        }
    })();
</script>

<!-- Mermaid JS -->
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    // Get theme colors from CSS variables
    const style = getComputedStyle(document.body);
    const primary = style.getPropertyValue('--primary').trim();
    const secondary = style.getPropertyValue('--bg-secondary').trim();
    const textPrimary = style.getPropertyValue('--text-primary').trim();

    mermaid.initialize({
        startOnLoad: false,
        theme: 'base',
        themeVariables: {
            fontFamily: 'Inter, sans-serif',
            primaryColor: primary,
            primaryTextColor: '#fff',
            primaryBorderColor: primary,
            lineColor: textPrimary,
            secondaryColor: secondary,
            tertiaryColor: '#f1f5f9'
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const mermaidBlocks = document.querySelectorAll('pre code.language-mermaid');
        if (mermaidBlocks.length > 0) {
            mermaidBlocks.forEach(block => {
                const div = document.createElement('div');
                div.className = 'mermaid';
                div.style.textAlign = 'center'; // Center the diagram
                div.style.background = 'var(--bg-tertiary)'; // Add subtle background
                div.style.padding = '20px';
                div.style.borderRadius = '12px';
                div.textContent = block.textContent;
                // Replace pre element with the new div
                block.parentElement.replaceWith(div);
            });

            await mermaid.run({
                querySelector: '.mermaid'
            });
        }
    });
</script>

    <!-- 侧边栏脚本 -->
    <script>
        (function () {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            function toggleSidebar() {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('visible');
                document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
            }

            function closeSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('visible');
                document.body.style.overflow = '';
            }

            if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

            document.querySelectorAll('.lesson-nav a').forEach(link => {
                link.addEventListener('click', closeSidebar);
            });

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') closeSidebar();
            });
        })();
    </script>
</body>

</html>