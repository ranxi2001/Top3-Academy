<!DOCTYPE html>
<html lang="{{ site.lang | default: 'zh-CN' }}">

<head>
    {% include head.html %}
</head>

<body>
    {% include header.html %}

    <!-- 侧边栏遮罩层 -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- 课程文档布局 -->
    <div class="course-document">
        <aside class="sidebar" id="sidebar">
            <h2>目录</h2>
            <nav class="lesson-nav">
                <ul>
                    {% assign current_dir = page.path | split: '/' | first %}
                    {% assign course_pages = site.html_pages | where_exp: "item", "item.path contains current_dir" %}
                    {% for p in course_pages %}
                    {% assign p_dir = p.path | split: '/' | first %}
                    {% if p_dir == current_dir and p.name != 'index.md' %}
                    <li {% if page.url==p.url %}class="active" {% endif %}>
                        <a href="{{ p.url | relative_url }}">{{ p.title }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}
                </ul>
            </nav>
        </aside>

        <main class="content">
            {{ content | md_to_html }}

            <div class="lesson-footer">
                <p>最后更新于 {{ page.date | date: "%Y年%m月%d日" }}</p>
                {% if page.edit_link %}
                <a href="{{ page.edit_link }}" class="edit-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                    编辑此页
                </a>
                {% endif %}
            </div>

            <div class="pagination">
                {% if page.previous.url %}
                <a href="{{ page.previous.url | relative_url }}" class="prev">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    {{ page.previous.title }}
                </a>
                {% endif %}
                {% if page.next.url %}
                <a href="{{ page.next.url | relative_url }}" class="next">
                    {{ page.next.title }}
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </a>
                {% endif %}
            </div>
        </main>

        <!-- 右侧目录 -->
        <aside class="toc" id="toc">
            <h2>本页目录</h2>
            <nav class="toc-nav">
                <ul class="toc-list" id="tocList">
                    <!-- 目录项将由 JavaScript 动态生成 -->
                </ul>
            </nav>
        </aside>
    </div>

    <!-- 侧边栏切换按钮 -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="切换目录">
        <svg viewBox="0 0 24 24" fill="white">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
        </svg>
    </button>

    {% include footer.html %}
    {% include scripts.html %}

    <!-- 侧边栏和目录脚本 -->
    <script>
        (function () {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            function toggleSidebar() {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('visible');
                document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
            }

            function closeSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('visible');
                document.body.style.overflow = '';
            }

            if (sidebarToggle) sidebarToggle.addEventListener('click', toggleSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);

            document.querySelectorAll('.lesson-nav a').forEach(link => {
                link.addEventListener('click', closeSidebar);
            });

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') closeSidebar;
            });

            // ============================================
            // TOC (右侧目录) 生成和高亮
            // ============================================
            const content = document.querySelector('.content');
            const tocList = document.getElementById('tocList');
            const toc = document.getElementById('toc');

            if (content && tocList) {
                // 提取所有 h2 和 h3 标题
                const headings = content.querySelectorAll('h2, h3');

                if (headings.length > 0) {
                    headings.forEach((heading, index) => {
                        // 为标题添加 ID（如果没有的话）
                        if (!heading.id) {
                            heading.id = `heading-${index}`;
                        }

                        // 创建目录项
                        const li = document.createElement('li');
                        li.className = `toc-item toc-${heading.tagName.toLowerCase()}`;

                        const a = document.createElement('a');
                        a.className = 'toc-link';
                        a.href = `#${heading.id}`;
                        a.textContent = heading.textContent;
                        a.dataset.target = heading.id;

                        // 平滑滚动
                        a.addEventListener('click', (e) => {
                            e.preventDefault();
                            heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            // 更新 URL hash
                            history.pushState(null, null, `#${heading.id}`);
                        });

                        li.appendChild(a);
                        tocList.appendChild(li);
                    });

                    // 滚动高亮
                    let throttleTimer;
                    const throttle = (callback, time) => {
                        if (throttleTimer) return;
                        throttleTimer = setTimeout(() => {
                            callback();
                            throttleTimer = null;
                        }, time);
                    };

                    const highlightTOC = () => {
                        const scrollPos = window.scrollY + 100; // 偏移量
                        let currentHeading = null;

                        headings.forEach(heading => {
                            const top = heading.offsetTop;
                            if (scrollPos >= top) {
                                currentHeading = heading;
                            }
                        });

                        // 移除所有高亮
                        document.querySelectorAll('.toc-link').forEach(link => {
                            link.classList.remove('active');
                        });

                        // 添加当前高亮
                        if (currentHeading) {
                            const activeLink = document.querySelector(`.toc-link[data-target="${currentHeading.id}"]`);
                            if (activeLink) {
                                activeLink.classList.add('active');
                            }
                        }
                    };

                    window.addEventListener('scroll', () => {
                        throttle(highlightTOC, 100);
                    });

                    // 初始高亮
                    highlightTOC();
                } else {
                    // 如果没有标题，隐藏TOC
                    if (toc) toc.style.display = 'none';
                }
            }
        })();
    </script>
</body>

</html>